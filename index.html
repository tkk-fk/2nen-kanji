<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
<title>‰∫åÂπ¥Áîü„ÅÆÊº¢Â≠ó „Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ</title>

<link href="https://fonts.googleapis.com/css2?family=BIZ+UDMincho:wght@400;700&family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f7fafc; --ink:#1f2937; --muted:#6b7280; --card:#ffffff;
    --accent:#2563eb; --accent-ink:#ffffff;
    --chip:#e5e7eb; --chip-on:#dbeafe; --chip-ring:#93c5fd;
    --radius:22px; --shadow:0 10px 30px rgba(0,0,0,.08);
    --ui-font-stack: "BIZ UDPGothic","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    --kyokasho-stack:
      "UD Digi Kyokasho N-R","UD Digi Kyokasho N-B","UD „Éá„Ç∏„Çø„É´ ÊïôÁßëÊõ∏‰Ωì N-R","UD „Éá„Ç∏„Çø„É´ ÊïôÁßëÊõ∏‰Ωì N-B",
      "Yu Kyokasho","YuKyokasho","YuKyokasho Yoko","Hiragino KyoKashotai W3","Hiragino KyoKashotai W6",
      "BIZ UDMincho","Noto Serif JP","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: var(--ui-font-stack);
    display:flex; align-items:center; justify-content:center; padding:16px;
  }
  .app{width:min(980px,96vw)}
  .panel{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:18px; display:flex; flex-direction:column; gap:14px;
  }
  .top{ display:flex; align-items:center; justify-content:center; gap:10px; }
  .btn{
    appearance:none; border:none; border-radius:14px; padding:12px 18px; font-size:16px; line-height:1; cursor:pointer;
    background:var(--chip); color:var(--ink);
    transition:background .15s ease, color .15s ease, transform .04s ease;
    font-family: var(--ui-font-stack);
  }
  .btn:active{ transform:translateY(1px) }
  .btn.primary{ background:var(--accent); color:var(--accent-ink); }
  .btn.switch.active{ background:var(--accent); color:var(--accent-ink); }
  .btn:disabled{ opacity:.5; cursor:not-allowed }
  .sep{ flex:1 }

  .sheet{ position:fixed; inset:0; background:rgba(0,0,0,.28); display:none; align-items:flex-end; justify-content:center; }
  .sheet.show{ display:flex }
  .sheet-inner{
    width:min(980px,100%); max-height:80vh; overflow:auto;
    background:var(--card); border-radius:20px 20px 0 0; box-shadow:var(--shadow);
    padding:16px 16px 18px; display:flex; flex-direction:column; gap:12px;
  }
  .sheet-head{ display:flex; align-items:center; }
  .sheet-title{ font-weight:700; }
  .sheet-close{ margin-left:auto; background:transparent; border:none; font-size:16px; color:var(--muted); cursor:pointer; }
  .grid{ display:grid; gap:8px; grid-template-columns: repeat(10, 1fr); }
  @media (max-width:640px){ .grid{ grid-template-columns: repeat(8, 1fr); } }
  .chip{
    background:var(--chip); border:none; border-radius:12px; padding:10px 0; cursor:pointer; font-size:18px;
    font-family: var(--kyokasho-stack);
  }
  .chip.on{ background:var(--chip-on); outline:3px solid var(--chip-ring); }
  .sheet-foot{ display:flex; gap:10px; margin-top:6px; }
  .ghost{ background:transparent; border:1px solid #cbd5e1 }

  .card-wrap{ display:none; flex-direction:column; gap:10px; }
  .backlink{ background:transparent; border:none; color:var(--muted); align-self:flex-start; cursor:pointer; padding:6px 6px; }
  .card{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding: clamp(14px, 6vw, 28px);
    display:flex; align-items:center; justify-content:center; gap: clamp(18px, 6vw, 48px);
    min-height: 48vh;
    user-select:none;
  }
  .kanji{
    font-family: var(--kyokasho-stack);
    font-size: clamp(80px, 22vw, 220px);
    line-height:1; letter-spacing: .02em;
    font-feature-settings: "palt" 1;
  }
  .answer{
    min-width: 32%;
    font-size: clamp(22px, 7vw, 42px);
    color: var(--muted);
    visibility: hidden;
    font-family: var(--ui-font-stack);
  }
  .answer.show{ visibility: visible; color: var(--ink); }
  .controls{ display:flex; align-items:center; gap:8px; }

  .finish{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.12); z-index:50;
  }
  .finish.show{ display:flex; animation: fade 1200ms ease; }
  .finish .box{
    background: var(--card); padding: 18px 22px; border-radius: 16px; box-shadow: var(--shadow);
    font-weight:700; font-size: 20px;
    font-family: var(--ui-font-stack);
  }
  @keyframes fade{ 0%{opacity:0} 15%{opacity:1} 85%{opacity:1} 100%{opacity:0} }
</style>
</head>
<body>
  <div class="app">
    <div class="panel" id="setup">
      <div class="top" aria-hidden="true" style="justify-content:center; font-weight:700;">‰∫åÂπ¥Áîü„ÅÆÊº¢Â≠ó „Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ</div>
      <div class="controls" style="justify-content:center;">
        <button class="btn switch" id="allBtn">„Åú„Çì„Å∂</button>
        <button class="btn switch" id="pickBtn">„Åà„Çâ„Å∂</button>
        <span class="sep"></span>
        <button class="btn primary" id="startBtn">„Çπ„Çø„Éº„Éà</button>
      </div>
    </div>

    <div class="card-wrap" id="play">
      <button class="backlink" id="backBtn">‚Üê „ÇÇ„Å©„Çã</button>
      <div class="card" id="card" role="button" aria-label="„Ç´„Éº„Éâ„Çí„Çø„ÉÉ„Éó">
        <div class="kanji" id="q"></div>
        <div class="answer" id="a"></div>
      </div>
    </div>
  </div>

  <div class="sheet" id="sheet" aria-modal="true" role="dialog">
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">Êº¢Â≠ó„Çí„Åà„Çâ„Å∂</div>
        <button class="sheet-close" id="closeSheet">„Å®„Åò„Çã ‚úï</button>
      </div>
      <div class="grid" id="grid"></div>
      <div class="sheet-foot">
        <button class="btn ghost" id="clearBtn">ÂÖ®Ëß£Èô§</button>
        <span class="sep"></span>
        <button class="btn primary" id="okBtn">OK</button>
      </div>
    </div>
  </div>

  <div class="finish" id="finish">
    <div class="box">„Åå„Çì„Å∞„Å£„Åü„Å≠üòä</div>
  </div>

<script>
const KANJI_LIST = [
  "Âºï","ÁæΩ","Èõ≤","Âúí","ÈÅ†","‰Ωï","Áßë","Â§è","ÂÆ∂","Ê≠å","Áîª","Âõû","‰ºö","Êµ∑","Áµµ","Â§ñ","Ëßí","Ê•Ω","Ê¥ª","Èñì",
  "‰∏∏","Â≤©","È°î","Ê±Ω","Ë®ò","Â∏∞","Âºì","Áâõ","È≠ö","‰∫¨","Âº∑","Êïô","Ëøë","ÂÖÑ","ÂΩ¢","Ë®à","ÂÖÉ","Âéü","Ë®Ä","Âè§",
  "Âçà","Âæå","Ë™û","Â∑•","ÂÖ¨","Â∫É","‰∫§","ÂÖâ","ËÄÉ","Ë°å","È´ò","ÈªÑ","Âêà","Ë∞∑","ÂõΩ","Èªí","‰ªä","Êâç","Á¥∞","‰Ωú",
  "ÁÆó","Ê≠¢","Â∏Ç","Áü¢","Âßâ","ÊÄù","Á¥ô","ÂØ∫","Ëá™","ÊôÇ","ÂÆ§","Á§æ","Âº±","È¶ñ","Áßã","ÈÄ±","Êò•","Êõ∏","Â∞ë","Â†¥",
  "Ëâ≤","È£ü","Êñ∞","Ë¶™","Âõ≥","Êï∞","Ë•ø","Â£∞","Êòü","Êô¥","Âàá","Èõ™","Ëàπ","Á∑ö","ÁµÑ","Êó©","Ëµ∞","Ëçâ","Â§ö","‰Ωì",
  "Â§™","Âè∞","Âú∞","Ê±†","Áü•","Ëå∂","Êòº","Èï∑","È≥•","Êúù","Áõ¥","ÈÄö","Âºü","Â∫ó","ÁÇπ","Èõª","ÂàÄ","ÂÜ¨","ÂΩì","Êù±",
  "Á≠î","È†≠","Âêå","ÈÅì","Ë™≠","ÂÜÖ","ËÇâ","È¶¨","Â£≤","Ë≤∑","È∫¶","Âçä","Áï™","Áà∂","È¢®","ÂàÜ","ËÅû","Á±≥","Ê≠©","ÊØç",
  "Êñπ","Âåó","ÊØé","Â¶π","‰∏á","Êòé","È≥¥","ÊØõ","ÈñÄ","Â§ú","Èáé","Âèã","Áî®","Êõú","Êù•","Èáå","ÁêÜ","Ë©±"
];

const READINGS = {
  "Âºï":"„Å≤„Åè„Éª„ÅÑ„Çì","ÁæΩ":"„ÅØ„Å≠„Éª„ÅÜ","Èõ≤":"„Åè„ÇÇ","Âúí":"„Åù„ÅÆ„Éª„Åà„Çì","ÈÅ†":"„Å®„Åä„ÅÑ„Éª„Åà„Çì",
  "‰Ωï":"„Å™„Å´„Éª„Å™„Çì","Áßë":"„Åã","Â§è":"„Å™„Å§","ÂÆ∂":"„ÅÑ„Åà„Éª„Åã","Ê≠å":"„ÅÜ„Åü„Éª„Åã",
  "Áîª":"„Åå","Âõû":"„Åæ„Çè„Çã„Éª„Åã„ÅÑ","‰ºö":"„ÅÇ„ÅÜ„Éª„Åã„ÅÑ","Êµ∑":"„ÅÜ„Åø","Áµµ":"„Åà","Â§ñ":"„Åù„Å®„Éª„Åå„ÅÑ",
  "Ëßí":"„Åã„Å©„Éª„Å§„ÅÆ„Éª„Åã„Åè","Ê•Ω":"„Åü„ÅÆ„Åó„ÅÑ„Éª„Åå„Åè„Éª„Çâ„Åè","Ê¥ª":"„Åã„Å§","Èñì":"„ÅÇ„ÅÑ„Å†„Éª„Åã„Çì",
  "‰∏∏":"„Åæ„Çã„Éª„Åå„Çì","Â≤©":"„ÅÑ„Çè","È°î":"„Åã„Åä","Ê±Ω":"„Åç","Ë®ò":"„Åó„Çã„Åô„Éª„Åç","Â∏∞":"„Åã„Åà„Çã„Éª„Åç",
  "Âºì":"„ÇÜ„Åø","Áâõ":"„ÅÜ„Åó","È≠ö":"„Åï„Åã„Å™„Éª„Åé„Çá","‰∫¨":"„Åç„Çá„ÅÜ„Éª„Åë„ÅÑ","Âº∑":"„Å§„Çà„ÅÑ„Éª„Åç„Çá„ÅÜ",
  "Êïô":"„Åä„Åó„Åà„Çã„Éª„Åç„Çá„ÅÜ","Ëøë":"„Å°„Åã„ÅÑ„Éª„Åç„Çì","ÂÖÑ":"„ÅÇ„Å´„Éª„Åë„ÅÑ„Éª„Åç„Çá„ÅÜ","ÂΩ¢":"„Åã„Åü„Å°„Éª„Åë„ÅÑ",
  "Ë®à":"„ÅØ„Åã„Çã„Éª„Åë„ÅÑ","ÂÖÉ":"„ÇÇ„Å®„Éª„Åí„Çì„Éª„Åå„Çì","Âéü":"„ÅØ„Çâ„Éª„Åí„Çì","Ë®Ä":"„ÅÑ„ÅÜ„Éª„Åí„Çì„Éª„Åî„Çì","Âè§":"„Åµ„Çã„ÅÑ„Éª„Åì",
  "Âçà":"„ÅÜ„Åæ„Éª„Åî","Âæå":"„ÅÇ„Å®„Éª„ÅÆ„Å°„Éª„Åî„Éª„Åì„ÅÜ","Ë™û":"„Åã„Åü„Çã„Éª„Åî","Â∑•":"„Åì„ÅÜ","ÂÖ¨":"„Åä„Åä„ÇÑ„Åë„Éª„Åì„ÅÜ",
  "Â∫É":"„Å≤„Çç„ÅÑ„Éª„Åì„ÅÜ","‰∫§":"„Åæ„Åò„Çè„Çã„Éª„Åì„ÅÜ","ÂÖâ":"„Å≤„Åã„Çä„Éª„Åì„ÅÜ","ËÄÉ":"„Åã„Çì„Åå„Åà„Çã„Éª„Åì„ÅÜ",
  "Ë°å":"„ÅÑ„Åè„Éª„Åì„ÅÜ„Éª„Åé„Çá„ÅÜ","È´ò":"„Åü„Åã„ÅÑ„Éª„Åì„ÅÜ","ÈªÑ":"„Åç„Éª„Åä„ÅÜ","Âêà":"„ÅÇ„ÅÜ„Éª„Åî„ÅÜ","Ë∞∑":"„Åü„Å´„Éª„Åì„Åè",
  "ÂõΩ":"„Åè„Å´„Éª„Åì„Åè","Èªí":"„Åè„Çç„Éª„Åì„Åè","‰ªä":"„ÅÑ„Åæ„Éª„Åì„Çì","Êâç":"„Åï„ÅÑ","Á¥∞":"„Åª„Åù„ÅÑ„Éª„Åì„Åæ„Åã„ÅÑ„Éª„Åï„ÅÑ",
  "‰Ωú":"„Å§„Åè„Çã„Éª„Åï„Åè","ÁÆó":"„Åï„Çì","Ê≠¢":"„Å®„Åæ„Çã„Éª„Å®„ÇÅ„Çã„Éª„Åó","Â∏Ç":"„Åó","Áü¢":"„ÇÑ",
  "Âßâ":"„ÅÇ„Å≠„Éª„Åó","ÊÄù":"„Åä„ÇÇ„ÅÜ„Éª„Åó","Á¥ô":"„Åã„Åø„Éª„Åó","ÂØ∫":"„Å¶„Çâ„Éª„Åò","Ëá™":"„Åø„Åö„Åã„Çâ„Éª„Åò",
  "ÊôÇ":"„Å®„Åç„Éª„Åò","ÂÆ§":"„Åó„Å§","Á§æ":"„Åó„ÇÉ","Âº±":"„Çà„Çè„ÅÑ„Éª„Åò„ÇÉ„Åè","È¶ñ":"„Åè„Å≥„Éª„Åó„ÇÖ",
  "Áßã":"„ÅÇ„Åç„Éª„Åó„ÇÖ„ÅÜ","ÈÄ±":"„Åó„ÇÖ„ÅÜ","Êò•":"„ÅØ„Çã„Éª„Åó„ÇÖ„Çì","Êõ∏":"„Åã„Åè„Éª„Åó„Çá","Â∞ë":"„Åô„Åè„Å™„ÅÑ„Éª„Åó„Çá„ÅÜ",
  "Â†¥":"„Å∞„Éª„Åò„Çá„ÅÜ","Ëâ≤":"„ÅÑ„Çç„Éª„Åó„Çá„Åè","È£ü":"„Åü„Åπ„Çã„Éª„Åó„Çá„Åè","Êñ∞":"„ÅÇ„Åü„Çâ„Åó„ÅÑ„Éª„Åó„Çì",
  "Ë¶™":"„Åä„ÇÑ„Éª„Åó„Åü„Åó„ÅÑ„Éª„Åó„Çì","Âõ≥":"„Åö„Éª„Å®","Êï∞":"„Åã„Åö„Éª„Åô„ÅÜ","Ë•ø":"„Å´„Åó„Éª„Åõ„ÅÑ„Éª„Åï„ÅÑ",
  "Â£∞":"„Åì„Åà„Éª„Åõ„ÅÑ","Êòü":"„Åª„Åó„Éª„Åõ„ÅÑ","Êô¥":"„ÅØ„Çå„Çã„Éª„Åõ„ÅÑ","Âàá":"„Åç„Çã„Éª„Åõ„Å§","Èõ™":"„ÇÜ„Åç„Éª„Åõ„Å§",
  "Ëàπ":"„Åµ„Å≠„Éª„Åõ„Çì","Á∑ö":"„Åõ„Çì","ÁµÑ":"„Åè„ÇÄ„Éª„Åù","Êó©":"„ÅØ„ÇÑ„ÅÑ„Éª„Åù„ÅÜ","Ëµ∞":"„ÅØ„Åó„Çã„Éª„Åù„ÅÜ",
  "Ëçâ":"„Åè„Åï„Éª„Åù„ÅÜ","Â§ö":"„Åä„Åä„ÅÑ„Éª„Åü","‰Ωì":"„Åã„Çâ„Å†„Éª„Åü„ÅÑ","Â§™":"„Åµ„Å®„ÅÑ","Âè∞":"„Å†„ÅÑ„Éª„Åü„ÅÑ",
  "Âú∞":"„Å°","Ê±†":"„ÅÑ„Åë„Éª„Å°","Áü•":"„Åó„Çã„Éª„Å°","Ëå∂":"„Å°„ÇÉ","Êòº":"„Å≤„Çã„Éª„Å°„ÇÖ„ÅÜ","Èï∑":"„Å™„Åå„ÅÑ„Éª„Å°„Çá„ÅÜ",
  "È≥•":"„Å®„Çä„Éª„Å°„Çá„ÅÜ","Êúù":"„ÅÇ„Åï„Éª„Å°„Çá„ÅÜ","Áõ¥":"„Å™„Åä„Åô„Éª„Å°„Çá„Åè","ÈÄö":"„Å®„Åä„Çã„Éª„Å§„ÅÜ",
  "Âºü":"„Åä„Å®„ÅÜ„Å®„Éª„Å¶„ÅÑ„Éª„Å†„ÅÑ","Â∫ó":"„Åø„Åõ„Éª„Å¶„Çì","ÁÇπ":"„Å¶„Çì","Èõª":"„Åß„Çì","ÂàÄ":"„Åã„Åü„Å™„Éª„Å®„ÅÜ",
  "ÂÜ¨":"„Åµ„ÇÜ„Éª„Å®„ÅÜ","ÂΩì":"„ÅÇ„Åü„Çã„Éª„Å®„ÅÜ","Êù±":"„Å≤„Åå„Åó„Éª„Å®„ÅÜ","Á≠î":"„Åì„Åü„Åà„Çã„Éª„Å®„ÅÜ",
  "È†≠":"„ÅÇ„Åü„Åæ„Éª„Å®„ÅÜ„Éª„Åö","Âêå":"„Åä„Å™„Åò„Éª„Å©„ÅÜ","ÈÅì":"„Åø„Å°„Éª„Å©„ÅÜ","Ë™≠":"„Çà„ÇÄ„Éª„Å©„Åè",
  "ÂÜÖ":"„ÅÜ„Å°„Éª„Å™„ÅÑ","ËÇâ":"„Å´„Åè","È¶¨":"„ÅÜ„Åæ„Éª„Å∞","Â£≤":"„ÅÜ„Çã„Éª„Å∞„ÅÑ","Ë≤∑":"„Åã„ÅÜ„Éª„Å∞„ÅÑ","È∫¶":"„ÇÄ„Åé„Éª„Å∞„Åè",
  "Âçä":"„ÅØ„Çì","Áï™":"„Å∞„Çì","Áà∂":"„Å°„Å°„Éª„Åµ","È¢®":"„Åã„Åú„Éª„Åµ„ÅÜ","ÂàÜ":"„Çè„Åë„Çã„Éª„Å∂„Çì„Éª„Åµ„Çì",
  "ËÅû":"„Åç„Åè„Éª„Å∂„Çì","Á±≥":"„Åì„ÇÅ„Éª„Åπ„ÅÑ","Ê≠©":"„ÅÇ„Çã„Åè„Éª„Åª","ÊØç":"„ÅØ„ÅØ„Éª„Åº","Êñπ":"„Åã„Åü„Éª„Åª„ÅÜ",
  "Âåó":"„Åç„Åü„Éª„Åª„Åè","ÊØé":"„Åæ„ÅÑ","Â¶π":"„ÅÑ„ÇÇ„ÅÜ„Å®„Éª„Åæ„ÅÑ","‰∏á":"„Åæ„Çì","Êòé":"„ÅÇ„Åã„Çã„ÅÑ„Éª„ÇÅ„ÅÑ„Éª„Åø„Çá„ÅÜ",
  "È≥¥":"„Å™„Åè„Éª„ÇÅ„ÅÑ","ÊØõ":"„Åë„Éª„ÇÇ„ÅÜ","ÈñÄ":"„ÇÇ„Çì","Â§ú":"„Çà„Çã„Éª„ÇÑ","Èáé":"„ÅÆ„Éª„ÇÑ","Âèã":"„Å®„ÇÇ„Éª„ÇÜ„ÅÜ",
  "Áî®":"„Çà„ÅÜ","Êõú":"„Çà„ÅÜ","Êù•":"„Åè„Çã„Éª„Çâ„ÅÑ","Èáå":"„Åï„Å®„Éª„Çä","ÁêÜ":"„Çä","Ë©±":"„ÅØ„Å™„Åô„Éª„Çè"
};

let picked = []; let order = []; let idx = 0; let showAns = false; let mode = null;

const setup = document.getElementById('setup');
const play = document.getElementById('play');
const qEl = document.getElementById('q');
const aEl = document.getElementById('a');
const card = document.getElementById('card');

const allBtn = document.getElementById('allBtn');
const pickBtn = document.getElementById('pickBtn');
const startBtn = document.getElementById('startBtn');
const backBtn = document.getElementById('backBtn');

const sheet = document.getElementById('sheet');
const grid = document.getElementById('grid');
const okBtn = document.getElementById('okBtn');
const clearBtn = document.getElementById('clearBtn');
const closeSheet = document.getElementById('closeSheet');

const finish = document.getElementById('finish');

updateStartEnable(); setActiveButtons();

allBtn.addEventListener('click', ()=>{
  picked = [...KANJI_LIST];
  mode = 'all'; setActiveButtons(); flashPickToast(); updateStartEnable();
});

pickBtn.addEventListener('click', ()=>{
  mode = 'pick'; setActiveButtons(); openPicker();
});

startBtn.addEventListener('click', ()=>{
  if(picked.length===0){ picked = [...KANJI_LIST]; mode='all'; setActiveButtons(); }
  begin();
});

backBtn.addEventListener('click', ()=>{ endAndReturn(); });

card.addEventListener('click', ()=>{
  if(!showAns){ showAns = true; aEl.classList.add('show'); }
  else{
    if(idx + 1 >= order.length){ finishRound(); }
    else{ idx++; showQuestion(); }
  }
});

function openPicker(){
  if(!grid.dataset.ready){
    const frag = document.createDocumentFragment();
    KANJI_LIST.forEach(k=>{
      const b = document.createElement('button');
      b.className = 'chip'; b.textContent = k; b.type='button';
      b.addEventListener('click', ()=> b.classList.toggle('on'));
      frag.appendChild(b);
    });
    grid.appendChild(frag); grid.dataset.ready = '1';
  }
  Array.from(grid.children).forEach(chip=> chip.classList.remove('on'));
  sheet.classList.add('show'); document.body.style.overflow='hidden';
}
closeSheet.addEventListener('click', closePicker);
okBtn.addEventListener('click', ()=>{
  picked = Array.from(grid.children).filter(el=>el.classList.contains('on')).map(el=>el.textContent);
  updateStartEnable(); closePicker();
});
clearBtn.addEventListener('click', ()=>{ Array.from(grid.children).forEach(el=>el.classList.remove('on')); });
function closePicker(){ sheet.classList.remove('show'); document.body.style.overflow=''; }

function begin(){
  order = picked.map(k => KANJI_LIST.indexOf(k)).filter(i=>i>=0);
  idx = 0; setup.style.display = 'none'; play.style.display = 'flex'; showQuestion();
}
function showQuestion(){
  const k = KANJI_LIST[order[idx]];
  qEl.textContent = k;
  aEl.textContent = READINGS[k] || "Ôºà„Çà„ÅøÊú™Ë®≠ÂÆöÔºâ";
  showAns = false; aEl.classList.remove('show');
}

function finishRound(){
  finish.classList.add('show');
  setTimeout(()=>{ finish.classList.remove('show'); endAndReturn(); }, 1200);
}
function endAndReturn(){
  play.style.display = 'none'; setup.style.display = '';
  idx = 0; showAns = false; aEl.classList.remove('show'); mode = null; setActiveButtons();
}

function setActiveButtons(){
  allBtn.classList.toggle('active', mode==='all');
  pickBtn.classList.toggle('active', mode==='pick');
}

function flashPickToast(){
  allBtn.animate([{transform:'scale(1)'},{transform:'scale(1.05)'},{transform:'scale(1)'}],{duration:220});
}
function updateStartEnable(){ startBtn.disabled = false; }
</script>
</body>
</html>
