<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
<title>äºŒå¹´ç”Ÿã®æ¼¢å­— ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</title>

<link href="https://fonts.googleapis.com/css2?family=BIZ+UDMincho:wght@400;700&family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f7fafc; --ink:#1f2937; --muted:#6b7280; --card:#ffffff;
    --accent:#2563eb; --accent-ink:#ffffff;
    --chip:#e5e7eb; --chip-on:#dbeafe; --chip-ring:#93c5fd;
    --radius:22px; --shadow:0 10px 30px rgba(0,0,0,.08);
    --ui-font-stack: "BIZ UDPGothic","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    --kyokasho-stack:
      "UD Digi Kyokasho N-R","UD Digi Kyokasho N-B","UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“ N-R","UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“ N-B",
      "Yu Kyokasho","YuKyokasho","YuKyokasho Yoko","Hiragino KyoKashotai W3","Hiragino KyoKashotai W6",
      "BIZ UDMincho","Noto Serif JP","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: var(--ui-font-stack);
    display:flex; align-items:center; justify-content:center; padding:16px;
  }
  .app{width:min(980px,96vw)}
  .panel{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:18px; display:flex; flex-direction:column; gap:14px;
  }
  .top{ display:flex; align-items:center; justify-content:center; gap:10px; }
  .btn{
    appearance:none; border:none; border-radius:14px; padding:12px 18px; font-size:16px; line-height:1; cursor:pointer;
    background:var(--chip); color:var(--ink);
    transition:background .15s ease, color .15s ease, transform .04s ease;
    font-family: var(--ui-font-stack);
  }
  .btn:active{ transform:translateY(1px) }
  .btn.primary{ background:var(--accent); color:var(--accent-ink); }
  .btn.switch.active{ background:var(--accent); color:var(--accent-ink); }
  .btn:disabled{ opacity:.5; cursor:not-allowed }
  .sep{ flex:1 }

  .sheet{ position:fixed; inset:0; background:rgba(0,0,0,.28); display:none; align-items:flex-end; justify-content:center; }
  .sheet.show{ display:flex }
  .sheet-inner{
    width:min(980px,100%); max-height:80vh; overflow:auto;
    background:var(--card); border-radius:20px 20px 0 0; box-shadow:var(--shadow);
    padding:16px 16px 18px; display:flex; flex-direction:column; gap:12px;
  }
  .sheet-head{ display:flex; align-items:center; }
  .sheet-title{ font-weight:700; }
  .sheet-close{ margin-left:auto; background:transparent; border:none; font-size:16px; color:var(--muted); cursor:pointer; }
  .grid{ display:grid; gap:8px; grid-template-columns: repeat(10, 1fr); }
  @media (max-width:640px){ .grid{ grid-template-columns: repeat(8, 1fr); } }
  .chip{
    background:var(--chip); border:none; border-radius:12px; padding:10px 0; cursor:pointer; font-size:18px;
    font-family: var(--kyokasho-stack);
  }
  .chip.on{ background:var(--chip-on); outline:3px solid var(--chip-ring); }
  .sheet-foot{ display:flex; gap:10px; margin-top:6px; }
  .ghost{ background:transparent; border:1px solid #cbd5e1 }

  .card-wrap{ display:none; flex-direction:column; gap:10px; }
  .backlink{ background:transparent; border:none; color:var(--muted); align-self:flex-start; cursor:pointer; padding:6px 6px; }
  .card{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding: clamp(14px, 6vw, 28px);
    display:flex; align-items:center; justify-content:center; gap: clamp(18px, 6vw, 48px);
    min-height: 48vh;
    user-select:none;
  }
  .kanji{
    font-family: var(--kyokasho-stack);
    font-size: clamp(80px, 22vw, 220px);
    line-height:1; letter-spacing: .02em;
    font-feature-settings: "palt" 1;
  }
  .answer{
    min-width: 32%;
    font-size: clamp(22px, 7vw, 42px);
    color: var(--muted);
    visibility: hidden;
    font-family: var(--ui-font-stack);
  }
  .answer.show{ visibility: visible; color: var(--ink); }
  .controls{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:center; }

  .finish{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.12); z-index:50;
  }
  .finish.show{ display:flex; animation: fade 1200ms ease; }
  .finish .box{
    background: var(--card); padding: 18px 22px; border-radius: 16px; box-shadow: var(--shadow);
    font-weight:700; font-size: 20px;
    font-family: var(--ui-font-stack);
  }
  @keyframes fade{ 0%{opacity:0} 15%{opacity:1} 85%{opacity:1} 100%{opacity:0} }

  /* æ‹¬å¼§å†…ï¼ˆé€ã‚Šä»®åï¼‰ã‚’èµ¤è¡¨ç¤º */
  .okuri{ color:#e11d48; font-weight:700; }
</style>
</head>
<body>
  <div class="app">
    <div class="panel" id="setup">
      <div class="top" aria-hidden="true" style="justify-content:center; font-weight:700;">äºŒå¹´ç”Ÿã®æ¼¢å­— ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</div>
      <div class="controls" style="justify-content:center;">
        <button class="btn switch" id="allBtn" aria-label="ãœã‚“ã¶">ãœã‚“ã¶</button>
        <button class="btn switch" id="pickBtn" aria-label="ãˆã‚‰ã¶">ãˆã‚‰ã¶</button>
        <button class="btn switch" id="randomBtn" aria-label="ãƒ©ãƒ³ãƒ€ãƒ 20å•">ãƒ©ãƒ³ãƒ€ãƒ 20å•</button>
        <span class="sep"></span>
        <button class="btn primary" id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>
    </div>

    <div class="card-wrap" id="play">
      <button class="backlink" id="backBtn">â† ã‚‚ã©ã‚‹</button>
      <div class="card" id="card" role="button" aria-label="ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—">
        <div class="kanji" id="q"></div>
        <div class="answer" id="a"></div>
      </div>
    </div>
  </div>

  <div class="sheet" id="sheet" aria-modal="true" role="dialog">
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">æ¼¢å­—ã‚’ãˆã‚‰ã¶</div>
        <button class="sheet-close" id="closeSheet">ã¨ã˜ã‚‹ âœ•</button>
      </div>
      <div class="grid" id="grid"></div>
      <div class="sheet-foot">
        <button class="btn ghost" id="clearBtn">å…¨è§£é™¤</button>
        <span class="sep"></span>
        <button class="btn primary" id="okBtn">OK</button>
      </div>
    </div>
  </div>

  <div class="finish" id="finish">
    <div class="box">ãŒã‚“ã°ã£ãŸã­ğŸ˜Š</div>
  </div>

<script>
/* ===== é€ã‚Šä»®åã‚’èµ¤ã«ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ ===== */
function formatReading(text){
  if(!text) return "";
  return text
    .split("ãƒ»")
    .map(t => t.replace(/\(([^)]+)\)/g, '<span class="okuri">$1</span>'))
    .join("ãƒ»");
}

/* --- å°å­¦äºŒå¹´ç”Ÿ æ¼¢å­—ãƒªã‚¹ãƒˆ --- */
const KANJI_LIST = [
  "å¼•","ç¾½","é›²","åœ’","é ","ä½•","ç§‘","å¤","å®¶","æ­Œ","ç”»","å›","ä¼š","æµ·","çµµ","å¤–","è§’","æ¥½","æ´»","é–“",
  "ä¸¸","å²©","é¡”","æ±½","è¨˜","å¸°","å¼“","ç‰›","é­š","äº¬","å¼·","æ•™","è¿‘","å…„","å½¢","è¨ˆ","å…ƒ","åŸ","è¨€","å¤",
  "åˆ","å¾Œ","èª","å·¥","å…¬","åºƒ","äº¤","å…‰","è€ƒ","è¡Œ","é«˜","é»„","åˆ","è°·","å›½","é»’","ä»Š","æ‰","ç´°","ä½œ",
  "ç®—","æ­¢","å¸‚","çŸ¢","å§‰","æ€","ç´™","å¯º","è‡ª","æ™‚","å®¤","ç¤¾","å¼±","é¦–","ç§‹","é€±","æ˜¥","æ›¸","å°‘","å ´",
  "è‰²","é£Ÿ","æ–°","è¦ª","å›³","æ•°","è¥¿","å£°","æ˜Ÿ","æ™´","åˆ‡","é›ª","èˆ¹","ç·š","çµ„","æ—©","èµ°","è‰","å¤š","ä½“",
  "å¤ª","å°","åœ°","æ± ","çŸ¥","èŒ¶","æ˜¼","é•·","é³¥","æœ","ç›´","é€š","å¼Ÿ","åº—","ç‚¹","é›»","åˆ€","å†¬","å½“","æ±",
  "ç­”","é ­","åŒ","é“","èª­","å†…","è‚‰","é¦¬","å£²","è²·","éº¦","åŠ","ç•ª","çˆ¶","é¢¨","åˆ†","è","ç±³","æ­©","æ¯",
  "æ–¹","åŒ—","æ¯","å¦¹","ä¸‡","æ˜","é³´","æ¯›","é–€","å¤œ","é‡","å‹","ç”¨","æ›œ","æ¥","é‡Œ","ç†","è©±"
];

/* --- èª­ã¿ï¼ˆæ‹¬å¼§å†…ï¼é€ã‚Šä»®åï¼‰ --- */
const READINGS = {
  "å¼•":"ã²(ã)ãƒ»ã„ã‚“",
  "ç¾½":"ã¯ã­ãƒ»ã†",
  "é›²":"ãã‚‚",
  "åœ’":"ãã®ãƒ»ãˆã‚“",
  "é ":"ã¨ãŠ(ã„)ãƒ»ãˆã‚“",
  "ä½•":"ãªã«ãƒ»ãªã‚“",
  "ç§‘":"ã‹",
  "å¤":"ãªã¤ãƒ»ã‹",
  "å®¶":"ã„ãˆãƒ»ã‹",
  "æ­Œ":"ã†ãŸãƒ»ã‹",
  "ç”»":"ãŒ",
  "å›":"ã¾ã‚(ã‚‹)ãƒ»ã‹ã„",
  "ä¼š":"ã‚(ã†)ãƒ»ã‹ã„",
  "æµ·":"ã†ã¿ãƒ»ã‹ã„",
  "çµµ":"ãˆ",
  "å¤–":"ãã¨ãƒ»ãŒã„",
  "è§’":"ã‹ã©ãƒ»ã¤ã®ãƒ»ã‹ã",
  "æ¥½":"ãŸã®(ã—ã„)ãƒ»ãŒããƒ»ã‚‰ã",
  "æ´»":"ã‹ã¤",
  "é–“":"ã‚ã„ã ãƒ»ã‹ã‚“",
  "ä¸¸":"ã¾ã‚‹ãƒ»ãŒã‚“",
  "å²©":"ã„ã‚ãƒ»ãŒã‚“",
  "é¡”":"ã‹ãŠ",
  "æ±½":"ã",
  "è¨˜":"ã—ã‚‹(ã™)ãƒ»ã",
  "å¸°":"ã‹ãˆ(ã‚‹)ãƒ»ã",
  "å¼“":"ã‚†ã¿",
  "ç‰›":"ã†ã—ãƒ»ãã‚…ã†",
  "é­š":"ã•ã‹ãªãƒ»ãã‚‡",
  "äº¬":"ãã‚‡ã†",
  "å¼·":"ã¤ã‚ˆ(ã„)ãƒ»ãã‚‡ã†",
  "æ•™":"ãŠã—(ãˆã‚‹)ãƒ»ãã‚‡ã†",
  "è¿‘":"ã¡ã‹(ã„)ãƒ»ãã‚“",
  "å…„":"ã‚ã«ãƒ»ã‘ã„ãƒ»ãã‚‡ã†",
  "å½¢":"ã‹ãŸã¡ãƒ»ã‘ã„",
  "è¨ˆ":"ã¯ã‹(ã‚‹)ãƒ»ã‘ã„",
  "å…ƒ":"ã‚‚ã¨ãƒ»ã’ã‚“ãƒ»ãŒã‚“",
  "åŸ":"ã¯ã‚‰ãƒ»ã’ã‚“",
  "è¨€":"ã„(ã†)ãƒ»ã’ã‚“ãƒ»ã”ã‚“",
  "å¤":"ãµã‚‹(ã„)ãƒ»ã“",
  "åˆ":"ã†ã¾ãƒ»ã”",
  "å¾Œ":"ã‚ã¨ãƒ»ã®ã¡ãƒ»ã”ãƒ»ã“ã†",
  "èª":"ã‹ãŸ(ã‚‹)ãƒ»ã”",
  "å·¥":"ã“ã†",
  "å…¬":"ã“ã†",
  "åºƒ":"ã²ã‚(ã„)",
  "äº¤":"ã¾ã˜(ã‚ã‚‹)ãƒ»ã“ã†",
  "å…‰":"ã²ã‹ã‚Šãƒ»ã“ã†",
  "è€ƒ":"ã‹ã‚“ãŒ(ãˆã‚‹)ãƒ»ã“ã†",
  "è¡Œ":"ã„(ã)ãƒ»ã“ã†ãƒ»ãã‚‡ã†",
  "é«˜":"ãŸã‹(ã„)ãƒ»ã“ã†",
  "é»„":"ããƒ»ãŠã†",
  "åˆ":"ã‚(ã†)ãƒ»ã”ã†",
  "è°·":"ãŸã«ãƒ»ã“ã",
  "å›½":"ãã«ãƒ»ã“ã",
  "é»’":"ãã‚ãƒ»ã“ã",
  "ä»Š":"ã„ã¾ãƒ»ã“ã‚“",
  "æ‰":"ã•ã„",
  "ç´°":"ã»ã(ã„)ãƒ»ã“ã¾(ã‹ã„)ãƒ»ã•ã„",
  "ä½œ":"ã¤ã(ã‚‹)ãƒ»ã•ã",
  "ç®—":"ã•ã‚“",
  "æ­¢":"ã¨(ã¾ã‚‹)ãƒ»ã—",
  "å¸‚":"ã—ãƒ»ã„ã¡",
  "çŸ¢":"ã‚„",
  "å§‰":"ã‚ã­ãƒ»ã—",
  "æ€":"ãŠã‚‚(ã†)ãƒ»ã—",
  "ç´™":"ã‹ã¿ãƒ»ã—",
  "å¯º":"ã¦ã‚‰ãƒ»ã˜",
  "è‡ª":"ã¿ãšã‹ã‚‰ãƒ»ã˜",
  "æ™‚":"ã¨ããƒ»ã˜",
  "å®¤":"ã—ã¤",
  "ç¤¾":"ã—ã‚ƒ",
  "å¼±":"ã‚ˆã‚(ã„)ãƒ»ã˜ã‚ƒã",
  "é¦–":"ãã³ãƒ»ã—ã‚…",
  "ç§‹":"ã‚ããƒ»ã—ã‚…ã†",
  "é€±":"ã—ã‚…ã†",
  "æ˜¥":"ã¯ã‚‹ãƒ»ã—ã‚…ã‚“",
  "æ›¸":"ã‹(ã)ãƒ»ã—ã‚‡",
  "å°‘":"ã™ã(ãªã„)ãƒ»ã—ã‚‡ã†",
  "å ´":"ã°ãƒ»ã˜ã‚‡ã†",
  "è‰²":"ã„ã‚ãƒ»ã—ã‚‡ã",
  "é£Ÿ":"ãŸ(ã¹ã‚‹)ãƒ»ã—ã‚‡ã",
  "æ–°":"ã‚ãŸã‚‰(ã—ã„)ãƒ»ã—ã‚“",
  "è¦ª":"ãŠã‚„ãƒ»ã—ãŸ(ã—ã„)ãƒ»ã—ã‚“",
  "å›³":"ãšãƒ»ã¨",
  "æ•°":"ã‹ãšãƒ»ã™ã†",
  "è¥¿":"ã«ã—",
  "å£°":"ã“ãˆãƒ»ã›ã„",
  "æ˜Ÿ":"ã»ã—ãƒ»ã›ã„",
  "æ™´":"ã¯(ã‚Œã‚‹)ãƒ»ã›ã„",
  "åˆ‡":"ã(ã‚‹)ãƒ»ã›ã¤",
  "é›ª":"ã‚†ããƒ»ã›ã¤",
  "èˆ¹":"ãµã­ãƒ»ã›ã‚“",
  "ç·š":"ã›ã‚“",
  "çµ„":"ã(ã‚€)ãƒ»ã",
  "æ—©":"ã¯ã‚„(ã„)ãƒ»ãã†",
  "èµ°":"ã¯ã—(ã‚‹)ãƒ»ãã†",
  "è‰":"ãã•ãƒ»ãã†",
  "å¤š":"ãŠãŠ(ã„)ãƒ»ãŸ",
  "ä½“":"ã‹ã‚‰ã ãƒ»ãŸã„",
  "å¤ª":"ãµã¨(ã„)",
  "å°":"ã ã„",
  "åœ°":"ã¡",
  "æ± ":"ã„ã‘ãƒ»ã¡",
  "çŸ¥":"ã—(ã‚‹)ãƒ»ã¡",
  "èŒ¶":"ã¡ã‚ƒ",
  "æ˜¼":"ã²ã‚‹ãƒ»ã¡ã‚…ã†",
  "é•·":"ãªãŒ(ã„)ãƒ»ã¡ã‚‡ã†",
  "é³¥":"ã¨ã‚Šãƒ»ã¡ã‚‡ã†",
  "æœ":"ã‚ã•ãƒ»ã¡ã‚‡ã†",
  "ç›´":"ãªãŠ(ã™)ãƒ»ã¡ã‚‡ã",
  "é€š":"ã¨ãŠ(ã‚‹)ãƒ»ã¤ã†",
  "å¼Ÿ":"ãŠã¨ã†ã¨ãƒ»ã¦ã„ãƒ»ã ã„",
  "åº—":"ã¿ã›ãƒ»ã¦ã‚“",
  "ç‚¹":"ã¦ã‚“",
  "é›»":"ã§ã‚“",
  "åˆ€":"ã‹ãŸãªãƒ»ã¨ã†",
  "å†¬":"ãµã‚†ãƒ»ã¨ã†",
  "å½“":"ã‚(ãŸã‚‹)ãƒ»ã¨ã†",
  "æ±":"ã²ãŒã—ãƒ»ã¨ã†",
  "ç­”":"ã“ãŸ(ãˆã‚‹)ãƒ»ã¨ã†",
  "é ­":"ã‚ãŸã¾ãƒ»ã¨ã†ãƒ»ãš",
  "åŒ":"ãŠãª(ã˜)ãƒ»ã©ã†",
  "é“":"ã¿ã¡ãƒ»ã©ã†",
  "èª­":"ã‚ˆ(ã‚€)ãƒ»ã©ã",
  "å†…":"ã†ã¡ãƒ»ãªã„",
  "è‚‰":"ã«ã",
  "é¦¬":"ã†ã¾ãƒ»ã°",
  "å£²":"ã†(ã‚‹)ãƒ»ã°ã„",
  "è²·":"ã‹(ã†)ãƒ»ã°ã„",
  "éº¦":"ã‚€ããƒ»ã°ã",
  "åŠ":"ã¯ã‚“",
  "ç•ª":"ã°ã‚“",
  "çˆ¶":"ã¡ã¡ãƒ»ãµ",
  "é¢¨":"ã‹ãœãƒ»ãµã†",
  "åˆ†":"ã‚(ã‘ã‚‹)ãƒ»ã¶ã‚“ãƒ»ãµã‚“",
  "è":"ã(ã)ãƒ»ã¶ã‚“",
  "ç±³":"ã“ã‚ãƒ»ã¹ã„",
  "æ­©":"ã‚ã‚‹(ã)ãƒ»ã»",
  "æ¯":"ã¯ã¯ãƒ»ã¼",
  "æ–¹":"ã‹ãŸãƒ»ã»ã†",
  "åŒ—":"ããŸãƒ»ã»ã",
  "æ¯":"ã¾ã„",
  "å¦¹":"ã„ã‚‚ã†ã¨ãƒ»ã¾ã„",
  "ä¸‡":"ã¾ã‚“",
  "æ˜":"ã‚ã‹ã‚‹(ã„)ãƒ»ã‚ã„ãƒ»ã¿ã‚‡ã†",
  "é³´":"ãª(ã)ãƒ»ã‚ã„",
  "æ¯›":"ã‘ãƒ»ã‚‚ã†",
  "é–€":"ã‚‚ã‚“",
  "å¤œ":"ã‚ˆã‚‹ãƒ»ã‚„",
  "é‡":"ã®ãƒ»ã‚„",
  "å‹":"ã¨ã‚‚ãƒ»ã‚†ã†",
  "ç”¨":"ã‚ˆã†",
  "æ›œ":"ã‚ˆã†",
  "æ¥":"ã(ã‚‹)ãƒ»ã‚‰ã„",
  "é‡Œ":"ã•ã¨ãƒ»ã‚Š","ç†":"ã‚Š",
  "è©±":"ã¯ãª(ã™)ãƒ»ã‚"
};

/* ===== çŠ¶æ…‹ ===== */
let picked = [];
let order = [];
let idx = 0;
let showAns = false;
let mode = null;

/* ===== è¦ç´  ===== */
const setup = document.getElementById('setup');
const play = document.getElementById('play');
const qEl = document.getElementById('q');
const aEl = document.getElementById('a');
const card = document.getElementById('card');

const allBtn = document.getElementById('allBtn');
const pickBtn = document.getElementById('pickBtn');
const randomBtn = document.getElementById('randomBtn');
const startBtn = document.getElementById('startBtn');
const backBtn = document.getElementById('backBtn');

const sheet = document.getElementById('sheet');
const grid = document.getElementById('grid');
const okBtn = document.getElementById('okBtn');
const clearBtn = document.getElementById('clearBtn');
const closeSheet = document.getElementById('closeSheet');

const finish = document.getElementById('finish');

updateStartEnable();
setActiveButtons();

/* ===== ãƒãƒ³ãƒ‰ãƒ© ===== */
allBtn.addEventListener('click', ()=>{
  picked = [...KANJI_LIST];
  mode = 'all'; setActiveButtons(); flashPickToast(); updateStartEnable();
});
pickBtn.addEventListener('click', ()=>{
  mode = 'pick'; setActiveButtons(); openPicker();
});
randomBtn.addEventListener('click', ()=>{
  picked = sampleUnique(KANJI_LIST, 20);
  mode = 'random20';
  setActiveButtons(); flashPickToast(); updateStartEnable();
});
startBtn.addEventListener('click', ()=>{
  if(picked.length===0){ picked = [...KANJI_LIST]; mode='all'; setActiveButtons(); }
  begin();
});
backBtn.addEventListener('click', ()=>{ endAndReturn(); });

/* ã‚«ãƒ¼ãƒ‰ï¼šã‚¯ãƒªãƒƒã‚¯ã§ç­”ãˆâ†’æ¬¡ã¸ */
card.addEventListener('click', nextOrReveal);

/* â˜… çŸ¢å°ã‚­ãƒ¼ï¼ˆâ†’ã§ç­”ãˆâ†’æ¬¡ã¸ã€â†ã§ã²ã¨ã¤æˆ»ã‚‹ï¼‰ */
window.addEventListener('keydown', (e)=>{
  if (!isPlaying()) return;
  if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') e.preventDefault();
  if (e.key === 'ArrowRight') nextOrReveal();
  if (e.key === 'ArrowLeft') prevOne();
});

/* ===== Picker sheet ===== */
function openPicker(){
  if(!grid.dataset.ready){
    const frag = document.createDocumentFragment();
    KANJI_LIST.forEach(k=>{
      const b = document.createElement('button');
      b.className = 'chip'; b.textContent = k; b.type='button';
      b.addEventListener('click', ()=> b.classList.toggle('on'));
      frag.appendChild(b);
    });
    grid.appendChild(frag); grid.dataset.ready = '1';
  }
  Array.from(grid.children).forEach(chip=> chip.classList.remove('on'));
  sheet.classList.add('show'); document.body.style.overflow='hidden';
}
closeSheet.addEventListener('click', closePicker);
okBtn.addEventListener('click', ()=>{
  picked = Array.from(grid.children).filter(el=>el.classList.contains('on')).map(el=>el.textContent);
  updateStartEnable(); closePicker();
});
clearBtn.addEventListener('click', ()=>{ Array.from(grid.children).forEach(el=>el.classList.remove('on')); });
function closePicker(){ sheet.classList.remove('show'); document.body.style.overflow=''; }

/* ===== ã‚²ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼ ===== */
function begin(){
  order = picked.map(k => KANJI_LIST.indexOf(k)).filter(i=>i>=0);
  if(mode === 'random20'){ shuffle(order); } // ãƒ©ãƒ³ãƒ€ãƒ 20å•ã¯å‡ºé¡Œé †ã‚‚ãƒ©ãƒ³ãƒ€ãƒ 
  idx = 0; setup.style.display = 'none'; play.style.display = 'flex'; showQuestion();
}
function showQuestion(){
  const k = KANJI_LIST[order[idx]];
  qEl.textContent = k;
  aEl.innerHTML = formatReading(READINGS[k] || "ï¼ˆã‚ˆã¿æœªè¨­å®šï¼‰");
  showAns = false; aEl.classList.remove('show');
}
function nextOrReveal(){
  if(!showAns){ showAns = true; aEl.classList.add('show'); return; }
  if(idx + 1 >= order.length){ finishRound(); }
  else{ idx++; showQuestion(); }
}
function prevOne(){
  if(idx === 0) return;
  idx--; showQuestion();
}

/* ===== çµ‚äº† ===== */
function finishRound(){
  finish.classList.add('show');
  setTimeout(()=>{ finish.classList.remove('show'); endAndReturn(); }, 1200);
}
function endAndReturn(){
  play.style.display = 'none'; setup.style.display = '';
  idx = 0; showAns = false; aEl.classList.remove('show');
  mode = null; setActiveButtons();
}

/* ===== ãƒ˜ãƒ«ãƒ‘ãƒ¼ ===== */
function setActiveButtons(){
  allBtn.classList.toggle('active', mode==='all');
  pickBtn.classList.toggle('active', mode==='pick');
  randomBtn.classList.toggle('active', mode==='random20');
}
function flashPickToast(){
  (mode==='random20' ? randomBtn : allBtn).animate(
    [{transform:'scale(1)'},{transform:'scale(1.05)'},{transform:'scale(1)'}],
    {duration:220}
  );
}
function updateStartEnable(){ startBtn.disabled = false; }
function isPlaying(){ return play.style.display === 'flex'; }

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}
function sampleUnique(source, n){
  const copy = [...source];
  shuffle(copy);
  return copy.slice(0, Math.min(n, copy.length));
}
</script>
</body>
</html>

